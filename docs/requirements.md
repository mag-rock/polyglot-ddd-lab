# 要求仕様書（予約・需要調整ドメイン）

## 1. 文書の目的
- DDD学習用プロダクトの基準となる要求を明確化し、各言語実装（Kotlin / Go / Rust / TypeScript）で共通の仕様とする。
- 境界づけられたコンテキストごとの挙動・データ・連携要求を整理し、設計/テストの合意点を作る。

## 2. ステークホルダー
- **学習者/開発者**: 実装・テストを行う。
- **AIアドバイザ**: 設計議論とレビューを支援。
- **施設提供者（オペレータ）**: 会議室/席の在庫を登録・管理し、価格調整を行う。
- **利用者（予約者）**: 空き状況を検索し、予約/キャンセル/支払いを行う。

## 3. スコープ
- 予約・需要調整シナリオにおける最小限のエンドツーエンド体験（検索→予約→決済→通知→キャンセル/返金）をカバーする。
- UIや外部サービスはスタブ/モックで代替し、DDD練習に必要なドメインロジックを中心に実装する。
- モジュラーモノリス構成を前提とし、CQRSとドメインイベントでコンテキスト連携する。

## 4. 想定する境界づけられたコンテキストと責務
1. **予約管理（コア）**
   - 在庫（席/会議室）のカレンダー管理と空き検索。
   - 予約の生成/確定/変更/キャンセル、キャンセルポリシーの適用。
   - 予約ライフサイクルのイベント発行（例: ReservationCreated, ReservationCancelled）。
2. **価格・需要調整（コア）**
   - 基本料金と需要シグナル（残枠率、時間帯、リードタイムなど）に基づく動的価格計算。
   - 価格決定イベントの発行と、予約管理への提示用価格提供。
3. **決済・請求（一般）**
   - 予約確定時の支払いオーソリ/キャプチャ（スタブ）。
   - キャンセル時の返金額計算と返金処理（スタブ）。
   - 請求書/領収書の発行（仮の識別子を生成）。
4. **アカウント/認証（補完）**
   - ユーザー（予約者/オペレータ）とロール管理。
   - 認可フック（例: 予約変更は予約者本人または管理者のみ）。
5. **カレンダー連携・通知（補完）**
   - 外部カレンダー連携のスタブ（予約確定/キャンセルの書き込みイベント）。
   - 通知送出（メール相当のスタブキュー）とリトライ。

## 5. ユースケース（代表シナリオ）
- 利用者が日時・人数で空き検索し、提示価格を確認して予約を確定する。
- 利用者が予約をキャンセルし、キャンセルポリシーに基づく返金額が計算される。
- オペレータが期間/時間帯/残枠率に応じた価格調整ルールを設定し、検索結果に反映される。
- 予約確定/キャンセル時に外部カレンダー書き込みと通知が行われる（スタブ）。
- システムイベントを購読して簡易レポート（予約数、キャンセル率、平均単価）を生成する読み取りモデルを更新する。

## 6. 機能要求
### 6.1 予約管理
- 空き検索: 施設ID/日時/人数で検索し、利用可能スロットと提示価格を返す。
- 予約生成: 在庫ロック→価格検証→予約作成→予約確定イベント発行。
- 予約変更: スロット変更時は在庫再検証を行う。価格差額が発生する場合は決済に通知。
- キャンセル: キャンセルポリシー（例: 開始24時間前までは全額返金、それ以降は50%返金、開始時刻以降は返金なし）を適用し、返金要求を発行。
- 在庫カレンダー: 在庫の登録/休止/容量変更を管理し、過去の履歴を保持する。

### 6.2 価格・需要調整
- 価格ルール管理: 基本料金、時間帯係数、残枠率トリガー、リードタイム係数を設定できる。
- 価格計算: 検索時および予約確定前に現在のルールで価格を算定し、バージョンを付与する。
- 価格イベント: PriceCalculated, PriceRuleChanged などを発行し、予約管理と読み取りモデルで利用する。

### 6.3 決済・請求
- 決済リクエスト: 予約確定時にオーソリ/キャプチャ（スタブ）を実行し、トランザクションIDを保存。
- 返金計算: キャンセルポリシーと経過時間を基に返金額を算定し、返金イベントを発行。
- 請求/領収書: 予約IDに紐づく簡易請求書番号を生成し、PDF等は生成しない。

### 6.4 アカウント/認証
- ユーザー登録: 予約者/オペレータの登録、ロール付与。
- 認可: コマンドごとに必要ロールを定義し、CQRSコマンド処理前に検証する。

### 6.5 カレンダー連携・通知
- 外部カレンダー: 予約確定/キャンセル時にスタブAPIを呼び、成功/失敗をイベントとして記録。
- 通知: 予約確定/キャンセル/価格変更時の通知メッセージをキューイングし、リトライ付きで配送ステータスを管理。

### 6.6 読み取りモデル（CQRSクエリ）
- 空き状況・提示価格のクエリ。
- 予約一覧/詳細（履歴含む）のクエリ。
- 簡易レポート: 日次予約数、キャンセル率、平均販売単価（ADR）などを集計。

## 7. 非機能要求
- パフォーマンス: 空き検索は P95 で 500ms 以内（スタブ環境基準）。書き込み系は 1s 以内で応答。
- 一貫性: 集約内は強整合。コンテキスト間は結果整合性を許容し、イベントで伝播。
- 可用性/復旧: 主要コマンドは冪等化（予約確定、キャンセル、決済リクエスト）。イベント処理はリトライとデッドレターを想定。
- 監査性: 予約・決済・返金の状態遷移をイベントログとして保持し、読み取りモデルで参照可能にする。
- セキュリティ: 認可の通過なしにコマンドを実行しない。個人情報は最小限（氏名/メール程度）。
- 観測性: 最低限のメトリクス（予約作成成功率、キャンセル率、決済成功率）とイベント処理の失敗ログを取得。

## 8. 制約・前提
- 外部サービス（決済/カレンダー/メール）はスタブとし、API契約のみ定義する。
- UIは最小限または無し。主なインターフェースはコマンド/クエリのAPI（RESTでもメッセージでも可）で表現する。
- モジュラーモノリス内でコンテキスト分割し、リポジトリ/集約/ドメインサービスを明示する。
- テストはTDDを基本とし、ユースケースごとの受入テストを優先的に整備する。

## 9. 受入条件（例）
- 主要ユースケース（検索→予約→決済、キャンセル→返金）が自動テストで緑になる。
- キャンセルポリシーが設定値どおりに適用されることがテストで検証される。
- 価格ルールを変更すると新しい検索結果に反映され、イベントログで確認できる。
- 冪等テスト: 同一予約確定/キャンセルコマンドを二重送信しても整合した最終状態になる。
- 外部連携スタブが失敗した場合、リトライまたは失敗ステータスが記録される。

## 10. 今後の拡張候補（任意）
- プロモーション/クーポンの導入。
- サービスフィーや税計算の追加。
- 座席レイアウトや設備オプション（プロジェクタ等）の選択。
- 定期予約や系列予約のサポート。
